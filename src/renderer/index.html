<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8">
  <!-- 僅保留本地/HTTP 播放，移除 YouTube 來源 -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 connect-src 'self' ws://localhost:* http://localhost:* http://127.0.0.1:*;
                 media-src 'self' blob: http://localhost:* http://127.0.0.1:*;
                 frame-src 'none'">
  <title>Subtitle Overlay</title>
  <style>
    :root {
      color-scheme: light;
      --surface: rgba(255, 255, 255, 0.86);
      --surface-soft: rgba(255, 255, 255, 0.72);
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --border: rgba(148, 163, 184, 0.45);
      --accent: #2563eb;
      --accent-strong: linear-gradient(135deg, #2563eb, #7c3aed);
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font: 15px/1.6 "Inter", "Noto Sans TC", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--surface);
      min-height: 100vh;
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0;
    }

    body.sidebar-open {
      overflow: hidden;
    }

    .app-shell {
      position: relative;
      width: 100%;
      min-height: 100vh;
      background: var(--surface);
      backdrop-filter: none;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .topbar {
      padding: 28px 32px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 24px;
    }

    .brand {
      display: flex;
      gap: 18px;
      align-items: center;
    }

    .brand-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: var(--accent-strong);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .brand h1 {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.02em;
    }

    .brand p {
      margin: 6px 0 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .top-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .bin-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-start;
      min-width: 260px;
    }

    .bin-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .bin-status {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--text-secondary);
      align-items: center;
    }

    .bin-status-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      transition: background 0.2s ease, color 0.2s ease;
    }

    .bin-status-item[data-state="ok"] {
      background: rgba(34, 197, 94, 0.18);
      color: #15803d;
    }

    .bin-status-item[data-state="fail"] {
      background: rgba(248, 113, 113, 0.18);
      color: #b91c1c;
    }

    .bin-status-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 11px;
      font-weight: 700;
      background: rgba(148, 163, 184, 0.35);
      color: var(--text-secondary);
    }

    .bin-status-item[data-state="ok"] .bin-status-icon {
      background: rgba(34, 197, 94, 0.2);
      color: #15803d;
    }

    .bin-status-item[data-state="fail"] .bin-status-icon {
      background: rgba(248, 113, 113, 0.22);
      color: #b91c1c;
    }

    .bin-progress {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      width: 100%;
    }

    .bin-progress.hidden {
      display: none;
    }

    .bin-progress progress {
      width: 200px;
      height: 6px;
      border-radius: 999px;
    }

    progress {
      appearance: none;
      border: none;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.3);
    }

    progress::-webkit-progress-bar {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 999px;
    }

    progress::-webkit-progress-value {
      background: var(--accent-strong);
      border-radius: 999px;
    }

    progress::-moz-progress-bar {
      background: var(--accent-strong);
      border-radius: 999px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
      background: rgba(148, 163, 184, 0.25);
      color: var(--text-primary);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 22px -14px rgba(15, 23, 42, 0.35);
    }

    .btn[data-selected="true"] {
      position: relative;
      padding-right: 42px;
    }

    .btn[data-selected="true"]::after {
      content: '✓';
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      font-weight: 600;
      color: currentColor;
    }

    .btn.primary {
      background: var(--accent-strong);
      color: #fff;
      box-shadow: 0 12px 24px -12px rgba(37, 99, 235, 0.65);
    }

    .btn.primary:hover {
      box-shadow: 0 16px 28px -12px rgba(37, 99, 235, 0.7);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-secondary);
    }

    .btn.subtle {
      padding: 8px 14px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-secondary);
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 13px;
    }

    .main-area {
      padding: 0 32px 32px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .card {
      background: var(--surface-soft);
      border-radius: var(--radius-md);
      padding: 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-shadow: 0 24px 36px -28px rgba(15, 23, 42, 0.45);
    }

    .card-header h2 {
      margin: 0;
      font-size: 22px;
    }

    .card-header p {
      margin: 6px 0 0;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .row {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
    }

    .row label {
      font-weight: 600;
      min-width: 120px;
      color: #1e293b;
    }

    .field-body {
      flex: 1 1 240px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input[type="text"],
    input[type="number"],
    input[type="search"] {
      width: 100%;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text-primary);
      font: inherit;
    }


    select {
      width: 100%;
      font: inherit;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 10px 46px 10px 18px;
      background-color: rgba(255, 255, 255, 0.85);
      color: var(--text-primary);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(124, 58, 237, 0.12)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%231f2937' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left top, right 16px center;
      background-size: 100% 100%, 16px;
      transition: border-color 0.18s ease, box-shadow 0.18s ease, background-color 0.18s ease;
    }

    select:focus {
      outline: none;
      border-color: rgba(37, 99, 235, 0.75);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      background-color: rgba(255, 255, 255, 0.95);
    }

    select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background-image: linear-gradient(135deg, rgba(148, 163, 184, 0.18), rgba(148, 163, 184, 0.1)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2367748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-position: left top, right 16px center;
      background-size: 100% 100%, 16px;
    }

    @media (forced-colors: active) {
      select {
        appearance: auto;
        background-image: none;
        padding-right: 14px;
        border-radius: 12px;
      }
    }


    #videoFile {
      display: none;
    }

    .action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .progress-row {
      margin-left: 120px;
    }

    .progress-line {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    #dlProg {
      width: 220px;
      display: none;
    }

    .hint {
      margin: 0 0 0 120px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .preview-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #localVideo {
      width: 100%;
      min-height: 320px;
      border-radius: 16px;
      background: #0f172a;
      box-shadow: 0 18px 34px -24px rgba(15, 23, 42, 0.8);
    }

    .info-line {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .apply-row {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    #applyMsg {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", monospace;
    }

    .muted {
      color: var(--text-secondary);
    }

    /* Sidebar */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 40;
    }

    .sidebar-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: min(420px, 92vw);
      height: 100vh;
      background: rgba(15, 23, 42, 0.95);
      color: #e2e8f0;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 41;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(12px);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 28px 28px 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .sidebar-content {
      padding: 18px 28px 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .sidebar .row label,
    .sidebar input,
    .sidebar select,
    .sidebar button {
      color: #e2e8f0;
    }

    .sidebar input,
    .sidebar select {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.3);

      width: 100%;
      padding: 10px 14px;
      border-radius: 12px;
      color: var(--text-primary);
      font: inherit;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      /* 預留右側空間，避免文字壓到箭頭 */
      padding-right: 2.5em;
      /* 依需要調整 */

      /* 自訂箭頭（SVG，可改顏色與大小） */
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat: no-repeat;

      /* 這裡決定箭頭距右邊距離：改 12px 即可「往左移」 */
      background-position: right 12px center;
      background-size: 1em auto;
    }

    /* 強制色彩模式下恢復原生，避免不可見 */
    @media (forced-colors: active) {
      select {
        appearance: auto;
        background-image: none;
        padding-right: 14px;
      }
    }

    .sidebar .btn {
      color: #e2e8f0;
    }

    .accordion {
      background: rgba(148, 163, 184, 0.08);
      border-radius: 16px;
      padding: 14px 18px;
    }

    .accordion>summary {
      list-style: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      color: #cbd5f5;
    }

    .accordion>summary::-webkit-details-marker {
      display: none;
    }

    .accordion>summary span {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .accordion>summary svg {
      transition: transform 0.2s ease;
    }

    .accordion[open]>summary svg {
      transform: rotate(90deg);
    }

    .accordion-content {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      font-size: 14px;
      color: #cbd5f5;
    }

    #ytLogWrap {
      background: rgba(15, 23, 42, 0.72);
      border-radius: 12px;
      padding: 12px;
    }

    #ytLogWrap summary {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #cbd5f5;
    }

    #ytLogWrap summary::-webkit-details-marker {
      display: none;
    }

    #ytLogWrap[open] summary svg {
      transform: rotate(90deg);
    }

    #ytLog {
      margin: 10px 0 0;
      max-height: 220px;
      overflow: auto;
      background: transparent;
      color: #f8fafc;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .sidebar small,
    .sidebar .hint {
      color: rgba(203, 213, 225, 0.82);
    }

    .sidebar .mono {
      color: #e2e8f0;
    }

    @media (min-width: 980px) {
      .main-area {
        grid-template-columns: 1.4fr 1fr;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 24px 12px 48px;
      }

      .app-shell {
        border-radius: 20px;
      }

      .brand {
        width: 100%;
        justify-content: center;
      }

      .topbar {
        justify-content: center;
      }

      .progress-row,
      .hint {
        margin-left: 0;
      }

      .row {
        flex-direction: column;
        align-items: stretch;
      }

      .row label {
        min-width: 0;
      }

      .apply-row {
        flex-direction: column;
        align-items: stretch;
      }

      #localVideo {
        min-height: 220px;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="brand">
        <div class="brand-icon">SO</div>
        <div>
          <h1>Subtitle Overlay</h1>
          <p>控制面板</p>
        </div>
      </div>
      <div class="top-actions">
        <div class="bin-actions">
          <div class="bin-controls">
            <button id="checkBins" class="btn primary">檢查 / 下載必要工具</button>
            <div id="binInfo" class="bin-status">
              <div class="bin-status-item" data-state="pending">
                <span id="binStatusYtIcon" class="bin-status-icon" aria-hidden>–</span>
                <span class="bin-status-text">yt-dlp</span>
              </div>
              <div class="bin-status-item" data-state="pending">
                <span id="binStatusFfmpegIcon" class="bin-status-icon" aria-hidden>–</span>
                <span class="bin-status-text">ffmpeg</span>
              </div>
            </div>
          </div>
          <div id="binProgressWrap" class="bin-progress hidden">
            <progress id="binProgressBar" max="100"></progress>
            <span id="binProgressLabel" class="mono"></span>
          </div>
        </div>
        <button id="toggleAdvanced" class="btn ghost">進階設定</button>
      </div>
    </header>

    <main class="main-area">
      <section class="card quick-card">
        <header class="card-header">
          <h2>快速開始</h2>
          <p>輸入來源或載入本地檔案，立即預覽字幕與媒體。</p>
        </header>
        <div class="stack">
          <div class="row">
            <label for="ytUrl">YouTube 連結</label>
            <div class="field-body">
              <input type="text" id="ytUrl" placeholder="https://www.youtube.com/watch?v=...">
              <div class="action-row">
                <button id="ytDownload" class="btn primary">下載影片</button>
                <button id="ytDownloadAudio" class="btn">下載音訊</button>
                <button id="ytFetch" class="btn">僅下載字幕</button>
                <button id="ytCancel" class="btn ghost small">取消</button>
              </div>
            </div>
          </div>
          <div class="row progress-row">
            <label></label>
            <div class="progress-line">
              <progress id="dlProg" max="100" value="0" style="display:none"></progress>
              <span id="dlTxt" class="mono"></span>
            </div>
          </div>
          <div class="row">
            <label for="pickVideo">本地媒體</label>
            <div class="action-row">
              <button id="pickVideo" class="btn" type="button">選擇媒體檔</button>
            </div>
            <input type="file" id="videoFile" accept="video/*,audio/*" hidden>
          </div>
          <div class="row">
            <label>本地字幕</label>
            <div class="action-row">
              <button id="pickSubs" class="btn">選擇字幕檔</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card preview-card">
        <header class="card-header">
          <h2>預覽與輸出</h2>
          <p>確認字幕同步後，將設定套用到 overlay。</p>
        </header>
        <div class="preview-area">
          <video id="localVideo" controls></video>
          <div id="activeCacheInfo" class="info-line mono"></div>
        </div>
        <div class="apply-row">
          <button id="applyToOverlay" class="btn primary">套用到 Overlay</button>
          <span id="applyMsg"></span>
        </div>
      </section>
    </main>
  </div>

  <div id="sidebarOverlay" class="sidebar-overlay"></div>
  <aside id="advancedSidebar" class="sidebar">
    <div class="sidebar-header">
      <h2>進階設定</h2>
      <button id="closeAdvanced" class="btn ghost small">關閉</button>
    </div>
    <div class="sidebar-content">
      <details class="accordion">
        <summary>
          <span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            Cookies（Netscape cookies.txt）
          </span>
        </summary>
        <div class="accordion-content">
          <div class="row">
            <button id="pickCookies" class="btn">選擇 cookies.txt</button>
            <button id="clearCookies" class="btn ghost small">清除</button>
          </div>
          <div id="cookiesView" class="mono">(未設定)</div>
          <small>若遇到 429 或需登入，請提供 cookies。如何匯出 YouTube cookies：<span
              class="mono">https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies</span></small>
        </div>
      </details>

      <details class="accordion">
        <summary>
          <span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            字型管理
          </span>
        </summary>
        <div class="accordion-content">
          <div class="row">
            <button id="pickFonts" class="btn">上傳字型</button>
            <span id="fontsPicked" class="mono muted"></span>
          </div>
        </div>
      </details>

      <details class="accordion">
        <summary>
          <span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            顯示樣式
          </span>
        </summary>
        <div class="accordion-content">
          <div class="row">
            <label for="maxWidth">最大寬度(px)</label>
            <input type="number" id="maxWidth" value="1920" min="320">
          </div>
          <div class="row">
            <label for="align">對齊</label>
            <select id="align">
              <option value="left">置左</option>
              <option value="center" selected>置中</option>
              <option value="right">置右</option>
            </select>
          </div>
          <div class="row">
            <label for="background">背景</label>
            <select id="background">
              <option value="transparent" selected>透明</option>
              <option value="green">綠幕</option>
            </select>
          </div>
        </div>
      </details>

      <details class="accordion">
        <summary>
          <span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            HTTP 輸出
          </span>
        </summary>
        <div class="accordion-content">
          <div class="row">
            <label for="port">端口 (port)</label>
            <input type="number" id="port" value="1976" min="1" max="65535">
          </div>
          <small>以 OBS Browser Source 指向 <span class="mono">http://localhost:<span
                id="portView">1976</span>/overlay</span></small>
        </div>
      </details>

      <details class="accordion">
        <summary>
          <span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            下載記錄
          </span>
        </summary>
        <div class="accordion-content">
          <details id="ytLogWrap">
            <summary>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden>
                <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
              <span>yt-dlp 日誌</span>
            </summary>
            <pre id="ytLog"></pre>
          </details>
        </div>
      </details>
    </div>
  </aside>

  <script type="module" src="./app.mjs"></script>
</body>

</html>